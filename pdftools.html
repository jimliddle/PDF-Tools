<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools - Local Page Extractor & Reorder</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .controls { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 15px; 
            align-items: flex-end; 
            flex-wrap: wrap; 
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }

        .export-settings { display: flex; align-items: center; gap: 10px; flex-grow: 1; justify-content: flex-end; }
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        
        #page-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }

        .page-card { 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            padding: 10px; 
            text-align: center; 
            background: #fff; 
            cursor: grab; 
            transition: transform 0.1s ease; 
            position: relative; 
            user-select: none;
        }
        .page-card:active { cursor: grabbing; }
        .page-card.selected { border-color: #007bff; background-color: #e7f1ff; }
        .page-card canvas { width: 100%; height: auto; border: 1px solid #eee; pointer-events: none; }
        
        /* Dragging styles */
        .sortable-ghost { opacity: 0.4; border: 2px dashed #007bff; }
        
        .checkbox-container { position: absolute; top: 8px; left: 8px; z-index: 10; }
        .checkbox-container input { width: 20px; height: 20px; cursor: pointer; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-outline { background-color: transparent; border: 1px solid #007bff; color: #007bff; font-size: 0.8em; padding: 5px 10px; margin-left: 5px; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #status { margin-bottom: 10px; font-size: 0.9em; color: #555; }
        .hint { font-size: 0.8em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="margin:0;">PDF Tools</h1>
            <div class="hint">Select pages and drag them to change the output order.</div>
        </div>
        <div id="bulk-actions" style="display:none;">
            <button class="btn-outline" onclick="toggleAll(true)">Select All</button>
            <button class="btn-outline" onclick="toggleAll(false)">Clear All</button>
        </div>
    </header>

    <div class="controls">
        <div>
            <label style="display:block; margin-bottom:5px; font-weight:bold;">1. Load PDF</label>
            <input type="file" id="pdf-upload" accept="application/pdf">
        </div>

        <div class="export-settings">
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">2. Rename & Save</label>
                <input type="text" id="filename-input" placeholder="New filename" value="extracted_pages">
                <span>.pdf</span>
                <button id="download-btn" class="btn btn-success" disabled>Export PDF</button>
            </div>
        </div>
    </div>

    <div id="status">Upload a file to start...</div>
    <div id="page-grid"></div>
</div>

<script>
    const { PDFDocument } = PDFLib;
    const pdfUpload = document.getElementById('pdf-upload');
    const downloadBtn = document.getElementById('download-btn');
    const pageGrid = document.getElementById('page-grid');
    const status = document.getElementById('status');
    const filenameInput = document.getElementById('filename-input');
    const bulkActions = document.getElementById('bulk-actions');

    let currentPdfBytes = null;
    let totalPagesCount = 0;

    // Initialize PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Initialize SortableJS on the grid
    new Sortable(pageGrid, {
        animation: 150,
        ghostClass: 'sortable-ghost'
    });

    pdfUpload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        status.textContent = "Processing PDF...";
        pageGrid.innerHTML = "";
        downloadBtn.disabled = true;
        bulkActions.style.display = 'block';

        const originalName = file.name.replace(/\.[^/.]+$/, "");
        filenameInput.value = `${originalName}_edited`;

        const arrayBuffer = await file.arrayBuffer();
        currentPdfBytes = arrayBuffer;

        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer.slice(0) }).promise;
        totalPagesCount = pdf.numPages;

        for (let i = 1; i <= totalPagesCount; i++) {
            const card = document.createElement('div');
            card.className = 'page-card';
            // Important: store the original 0-based index
            card.dataset.originalIndex = i - 1; 
            card.id = `page-slot-${i}`;
            card.innerHTML = `<div style="height:200px; display:flex; align-items:center; justify-content:center;">...</div>`;
            pageGrid.appendChild(card);
            renderPagePreview(pdf, i);
        }
        updateStatus();
    });

    async function renderPagePreview(pdf, pageNum) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 0.4 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: context, viewport: viewport }).promise;

        const card = document.getElementById(`page-slot-${pageNum}`);
        card.innerHTML = `
            <div class="checkbox-container">
                <input type="checkbox" class="page-checkbox">
            </div>
            <div style="font-size:0.75em; font-weight:bold; margin-top:5px;">Original Page ${pageNum}</div>
        `;
        card.prepend(canvas);

        card.onclick = (e) => {
            const cb = card.querySelector('.page-checkbox');
            if (e.target !== cb) cb.checked = !cb.checked;
            
            if (cb.checked) card.classList.add('selected');
            else card.classList.remove('selected');
            
            checkSelectionCount();
        };
    }

    function checkSelectionCount() {
        const selectedCount = document.querySelectorAll('.page-checkbox:checked').length;
        downloadBtn.disabled = selectedCount === 0;
        status.textContent = `${totalPagesCount} pages loaded. ${selectedCount} selected for export.`;
    }

    function updateStatus() {
        status.textContent = `${totalPagesCount} pages loaded. Drag thumbnails to reorder.`;
    }

    function toggleAll(select) {
        document.querySelectorAll('.page-card').forEach(card => {
            const cb = card.querySelector('.page-checkbox');
            if (cb) {
                cb.checked = select;
                if (select) card.classList.add('selected');
                else card.classList.remove('selected');
            }
        });
        checkSelectionCount();
    }

    downloadBtn.addEventListener('click', async () => {
        status.textContent = "Generating your PDF...";
        
        try {
            const pdfCopy = currentPdfBytes.slice(0);
            const srcDoc = await PDFDocument.load(pdfCopy);
            const newDoc = await PDFDocument.create();
            
            // This is the magic: we look at the CURRENT order of cards in the DOM
            const cards = Array.from(pageGrid.querySelectorAll('.page-card'));
            const pagesToCopy = [];

            cards.forEach(card => {
                const cb = card.querySelector('.page-checkbox');
                if (cb && cb.checked) {
                    // Get the original index we stored earlier
                    pagesToCopy.push(parseInt(card.dataset.originalIndex));
                }
            });

            if (pagesToCopy.length === 0) return;

            const copiedPages = await newDoc.copyPages(srcDoc, pagesToCopy);
            copiedPages.forEach(p => newDoc.addPage(p));

            const pdfBytes = await newDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            
            let name = filenameInput.value.trim() || 'reordered_document';
            if (!name.toLowerCase().endsWith('.pdf')) name += '.pdf';

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = name;
            link.click();
            
            status.textContent = "PDF Exported Successfully!";
        } catch (err) {
            console.error(err);
            status.textContent = "Error during export: " + err.message;
        }
    });
</script>

</body>
</html>
